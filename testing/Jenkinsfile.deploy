// PMS Deployment Pipeline
// Triggered after backend build pipeline completes
// Pulls images from Docker Hub and deploys to Docker Swarm
// Works on any machine with Docker installed (auto-initializes Swarm)

pipeline {
    agent any

    environment {
        STACK_NAME = 'pms'
        DOCKER_HUB_BACKEND = 'amaleltelabany'
        DOCKER_HUB_FRONTEND = 'salmawaleedd'
    }

    stages {
        stage('Initialize Docker Swarm') {
            steps {
                sh '''
                    echo "=========================================="
                    echo "  Checking Docker Swarm Status"
                    echo "=========================================="

                    # Check if Swarm is active
                    SWARM_STATUS=$(docker info --format '{{.Swarm.LocalNodeState}}' 2>/dev/null || echo "inactive")

                    if [ "$SWARM_STATUS" = "active" ]; then
                        echo "Docker Swarm is already active"
                        docker node ls
                    else
                        echo "Initializing Docker Swarm..."
                        # Try to init, handle multiple network interfaces
                        docker swarm init 2>/dev/null || docker swarm init --advertise-addr $(hostname -I | awk '{print $1}') 2>/dev/null || echo "Swarm init failed or already initialized"

                        # Verify
                        sleep 2
                        if docker node ls 2>/dev/null; then
                            echo "Docker Swarm initialized successfully!"
                        else
                            echo "ERROR: Could not initialize Docker Swarm"
                            exit 1
                        fi
                    fi
                '''
            }
        }

        stage('Pull All Images') {
            parallel {
                stage('Pull Backend Images') {
                    steps {
                        sh '''
                            echo "=========================================="
                            echo "  Pulling Backend Images (amaleltelabany)"
                            echo "=========================================="
                            docker pull ${DOCKER_HUB_BACKEND}/pms-booking-service:latest
                            docker pull ${DOCKER_HUB_BACKEND}/pms-invoice-service:latest
                            docker pull ${DOCKER_HUB_BACKEND}/pms-site-service:latest
                            echo "Backend images pulled!"
                        '''
                    }
                }
                stage('Pull Frontend Images') {
                    steps {
                        sh '''
                            echo "=========================================="
                            echo "  Pulling Frontend Images (salmawaleedd)"
                            echo "=========================================="
                            docker pull ${DOCKER_HUB_FRONTEND}/pms-admin-frontend:latest
                            docker pull ${DOCKER_HUB_FRONTEND}/pms-parker-frontend:latest
                            echo "Frontend images pulled!"
                        '''
                    }
                }
            }
        }

        stage('Clean Previous Stack') {
            steps {
                sh '''
                    if docker stack ls | grep -q "${STACK_NAME}"; then
                        echo "Removing existing stack..."
                        docker stack rm ${STACK_NAME}
                        sleep 20
                    fi
                '''
            }
        }

        stage('Deploy to Swarm') {
            steps {
                dir('testing') {
                    sh '''
                        echo "=========================================="
                        echo "  Deploying to Docker Swarm"
                        echo "=========================================="
                        docker stack deploy -c docker-stack.yml ${STACK_NAME}
                        sleep 30
                    '''
                }
            }
        }

        stage('Wait for Infrastructure') {
            steps {
                sh '''
                    echo "Waiting for Zookeeper..."
                    for i in $(seq 1 30); do
                        ZK=$(docker ps --filter "name=${STACK_NAME}_zookeeper" -q | head -1)
                        if [ -n "$ZK" ] && docker exec $ZK nc -z localhost 2181 2>/dev/null; then
                            echo "Zookeeper ready!"
                            break
                        fi
                        sleep 3
                    done

                    echo "Waiting for Kafka..."
                    for i in $(seq 1 60); do
                        # Filter for cp-kafka image (not kafka-ui)
                        KAFKA=$(docker ps --filter "name=${STACK_NAME}_kafka" --format "{{.ID}}\t{{.Image}}" | grep "cp-kafka" | cut -f1 | head -1)
                        if [ -n "$KAFKA" ]; then
                            # Use kafka-topics to verify broker is ready
                            if docker exec $KAFKA kafka-topics --list --bootstrap-server localhost:9092 2>/dev/null; then
                                echo "Kafka ready!"
                                break
                            fi
                        fi
                        echo "Waiting for Kafka... ($i/60)"
                        sleep 5
                    done

                    echo "Waiting for SQL Server..."
                    for i in $(seq 1 60); do
                        SQL=$(docker ps --filter "name=${STACK_NAME}_sqlserver" -q | head -1)
                        if [ -n "$SQL" ] && docker exec $SQL /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -C -Q "SELECT 1" 2>/dev/null; then
                            echo "SQL Server ready!"
                            break
                        fi
                        sleep 5
                    done
                '''
            }
        }

        stage('Create Kafka Topics') {
            steps {
                sh '''
                    echo "Getting Kafka container (cp-kafka image)..."
                    KAFKA=$(docker ps --filter "name=${STACK_NAME}_kafka" --format "{{.ID}}\t{{.Image}}" | grep "cp-kafka" | cut -f1 | head -1)

                    if [ -z "$KAFKA" ]; then
                        echo "ERROR: Could not find Kafka container"
                        exit 1
                    fi

                    echo "Found Kafka container: $KAFKA"
                    echo "Creating Kafka topics..."

                    docker exec $KAFKA kafka-topics --create --topic site-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || echo "site-created topic already exists or auto-created"
                    docker exec $KAFKA kafka-topics --create --topic booking-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || echo "booking-created topic already exists or auto-created"
                    docker exec $KAFKA kafka-topics --create --topic ticket-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || echo "ticket-created topic already exists or auto-created"
                    docker exec $KAFKA kafka-topics --create --topic invoice-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || echo "invoice-created topic already exists or auto-created"

                    echo ""
                    echo "Verifying topics..."
                    docker exec $KAFKA kafka-topics --list --bootstrap-server localhost:9092

                    echo ""
                    echo "Topics ready! Waiting 5s for propagation..."
                    sleep 5
                '''
            }
        }

        stage('Start Backend Services') {
            steps {
                sh '''
                    echo "=========================================="
                    echo "  Starting Backend Services (Sequential)"
                    echo "=========================================="
                    echo "Starting services one at a time to avoid DB migration conflicts..."

                    # 1. Start Site Service first (other services depend on sites)
                    echo ""
                    echo ">>> Starting Site Service..."
                    docker service scale ${STACK_NAME}_site-service=1
                    echo "Waiting for Site Service to complete DB migration..."
                    for i in $(seq 1 30); do
                        SITE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5003/api/site 2>/dev/null || echo "000")
                        if [ "$SITE_STATUS" = "200" ]; then
                            echo "Site Service is ready!"
                            break
                        fi
                        echo "Waiting for Site Service... ($i/30) - Status: $SITE_STATUS"
                        sleep 10
                    done

                    # 2. Start Booking Service
                    echo ""
                    echo ">>> Starting Booking Service..."
                    docker service scale ${STACK_NAME}_booking-service=1
                    echo "Waiting for Booking Service to complete DB migration..."
                    for i in $(seq 1 30); do
                        BOOKING_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001/api/booking 2>/dev/null || echo "000")
                        if [ "$BOOKING_STATUS" = "200" ]; then
                            echo "Booking Service is ready!"
                            break
                        fi
                        echo "Waiting for Booking Service... ($i/30) - Status: $BOOKING_STATUS"
                        sleep 10
                    done

                    # 3. Start Invoice Service
                    echo ""
                    echo ">>> Starting Invoice Service..."
                    docker service scale ${STACK_NAME}_invoice-service=1
                    echo "Waiting for Invoice Service to complete DB migration..."
                    for i in $(seq 1 30); do
                        INVOICE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5002/api/invoice 2>/dev/null || echo "000")
                        if [ "$INVOICE_STATUS" = "200" ]; then
                            echo "Invoice Service is ready!"
                            break
                        fi
                        echo "Waiting for Invoice Service... ($i/30) - Status: $INVOICE_STATUS"
                        sleep 10
                    done

                    echo ""
                    echo "All backend services started!"
                    echo ""
                    echo "Container status:"
                    docker ps -a --filter "name=${STACK_NAME}_booking" --filter "name=${STACK_NAME}_invoice" --filter "name=${STACK_NAME}_site" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
                '''
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                    echo "=========================================="
                    echo "  Health Check"
                    echo "=========================================="

                    echo "Checking service status..."
                    docker stack services ${STACK_NAME}
                    echo ""

                    echo "Checking backend container status..."
                    docker ps -a --filter "name=${STACK_NAME}_booking" --filter "name=${STACK_NAME}_invoice" --filter "name=${STACK_NAME}_site" --format "table {{.Names}}\t{{.Status}}"
                    echo ""

                    for i in $(seq 1 20); do
                        BOOKING=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001/api/booking 2>/dev/null || echo "000")
                        INVOICE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5002/api/invoice 2>/dev/null || echo "000")
                        SITE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5003/api/site 2>/dev/null || echo "000")

                        echo "Booking: $BOOKING | Invoice: $INVOICE | Site: $SITE"

                        if [ "$BOOKING" = "200" ] && [ "$INVOICE" = "200" ] && [ "$SITE" = "200" ]; then
                            echo "All services healthy!"
                            break
                        fi
                        echo "Waiting for services... ($i/20)"
                        sleep 10
                    done

                    echo ""
                    echo "=== Final Service Status ==="
                    docker stack services ${STACK_NAME}
                '''
            }
        }
    }

    post {
        success {
            echo '''
=========================================
  DEPLOYMENT SUCCESSFUL!
=========================================

Frontend:
  - Admin:  http://localhost:4200
  - Parker: http://localhost:4201

APIs:
  - Booking: http://localhost:5001/api/booking
  - Invoice: http://localhost:5002/api/invoice
  - Site:    http://localhost:5003/api/site

Monitoring:
  - Kibana:     http://localhost:5601
  - Kafka UI:   http://localhost:8085
  - Visualizer: http://localhost:9080
            '''
        }
        failure {
            sh '''
                echo "=== Stack Services Status ==="
                docker stack services ${STACK_NAME} || true
                echo ""
                echo "=== Failed Tasks ==="
                docker stack ps ${STACK_NAME} --no-trunc | grep -E "Failed|Rejected|Shutdown" || true
                echo ""
                echo "=== Backend Service Logs ==="
                BOOKING=$(docker ps -a --filter "name=${STACK_NAME}_booking" -q | head -1)
                INVOICE=$(docker ps -a --filter "name=${STACK_NAME}_invoice" -q | head -1)
                SITE=$(docker ps -a --filter "name=${STACK_NAME}_site" -q | head -1)
                [ -n "$BOOKING" ] && echo "--- Booking Service ---" && docker logs $BOOKING --tail 50 2>&1 || true
                [ -n "$INVOICE" ] && echo "--- Invoice Service ---" && docker logs $INVOICE --tail 50 2>&1 || true
                [ -n "$SITE" ] && echo "--- Site Service ---" && docker logs $SITE --tail 50 2>&1 || true
            '''
        }
    }
}
