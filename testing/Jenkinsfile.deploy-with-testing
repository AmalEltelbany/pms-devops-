// PMS Deployment Pipeline with Automated Testing
// Deploys to Docker Swarm then triggers PMS-Testing pipeline
// Requires: A separate Jenkins job 'pms-testing' pointing to PMS-Testing repo

pipeline {
    agent any

    environment {
        STACK_NAME = 'pms'
        DOCKER_HUB_BACKEND = 'amaleltelabany'
        DOCKER_HUB_FRONTEND = 'salmawaleedd'
    }

    parameters {
        booleanParam(
            name: 'RUN_TESTS',
            defaultValue: true,
            description: 'Trigger automated tests after deployment'
        )
        booleanParam(
            name: 'WAIT_FOR_TESTS',
            defaultValue: true,
            description: 'Wait for test results before completing'
        )
    }

    stages {
        // ==========================================
        // DEPLOYMENT STAGES
        // ==========================================

        stage('Pull All Images') {
            parallel {
                stage('Pull Backend Images') {
                    steps {
                        sh '''
                            echo "=========================================="
                            echo "  Pulling Backend Images (amaleltelabany)"
                            echo "=========================================="
                            docker pull ${DOCKER_HUB_BACKEND}/pms-booking-service:latest
                            docker pull ${DOCKER_HUB_BACKEND}/pms-invoice-service:latest
                            docker pull ${DOCKER_HUB_BACKEND}/pms-site-service:latest
                            echo "Backend images pulled!"
                        '''
                    }
                }
                stage('Pull Frontend Images') {
                    steps {
                        sh '''
                            echo "=========================================="
                            echo "  Pulling Frontend Images (salmawaleedd)"
                            echo "=========================================="
                            docker pull ${DOCKER_HUB_FRONTEND}/pms-admin-frontend:latest
                            docker pull ${DOCKER_HUB_FRONTEND}/pms-parker-frontend:latest
                            echo "Frontend images pulled!"
                        '''
                    }
                }
            }
        }

        stage('Clean Previous Stack') {
            steps {
                sh '''
                    if docker stack ls | grep -q "${STACK_NAME}"; then
                        echo "Removing existing stack..."
                        docker stack rm ${STACK_NAME}
                        sleep 20
                    fi
                '''
            }
        }

        stage('Deploy to Swarm') {
            steps {
                dir('testing') {
                    sh '''
                        echo "=========================================="
                        echo "  Deploying to Docker Swarm"
                        echo "=========================================="
                        docker stack deploy -c docker-stack.yml ${STACK_NAME}
                        sleep 30
                    '''
                }
            }
        }

        stage('Wait for Infrastructure') {
            steps {
                sh '''
                    echo "Waiting for Zookeeper..."
                    for i in $(seq 1 30); do
                        ZK=$(docker ps --filter "name=${STACK_NAME}_zookeeper" -q | head -1)
                        if [ -n "$ZK" ] && docker exec $ZK nc -z localhost 2181 2>/dev/null; then
                            echo "Zookeeper ready!"
                            break
                        fi
                        sleep 3
                    done

                    echo "Waiting for Kafka..."
                    for i in $(seq 1 60); do
                        KAFKA=$(docker ps --filter "name=${STACK_NAME}_kafka" --format "{{.ID}}\t{{.Image}}" | grep "cp-kafka" | cut -f1 | head -1)
                        if [ -n "$KAFKA" ]; then
                            if docker exec $KAFKA kafka-topics --list --bootstrap-server localhost:9092 2>/dev/null; then
                                echo "Kafka ready!"
                                break
                            fi
                        fi
                        echo "Waiting for Kafka... ($i/60)"
                        sleep 5
                    done

                    echo "Waiting for SQL Server..."
                    for i in $(seq 1 60); do
                        SQL=$(docker ps --filter "name=${STACK_NAME}_sqlserver" -q | head -1)
                        if [ -n "$SQL" ] && docker exec $SQL /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -C -Q "SELECT 1" 2>/dev/null; then
                            echo "SQL Server ready!"
                            break
                        fi
                        sleep 5
                    done
                '''
            }
        }

        stage('Create Kafka Topics') {
            steps {
                sh '''
                    echo "Getting Kafka container (cp-kafka image)..."
                    KAFKA=$(docker ps --filter "name=${STACK_NAME}_kafka" --format "{{.ID}}\t{{.Image}}" | grep "cp-kafka" | cut -f1 | head -1)

                    if [ -z "$KAFKA" ]; then
                        echo "ERROR: Could not find Kafka container"
                        exit 1
                    fi

                    echo "Found Kafka container: $KAFKA"
                    echo "Creating Kafka topics..."

                    docker exec $KAFKA kafka-topics --create --topic site-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true
                    docker exec $KAFKA kafka-topics --create --topic booking-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true
                    docker exec $KAFKA kafka-topics --create --topic ticket-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true
                    docker exec $KAFKA kafka-topics --create --topic invoice-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true

                    echo "Topics ready!"
                    docker exec $KAFKA kafka-topics --list --bootstrap-server localhost:9092
                    sleep 5
                '''
            }
        }

        stage('Start Backend Services') {
            steps {
                sh '''
                    echo "Starting backend services..."
                    docker service scale ${STACK_NAME}_booking-service=1 ${STACK_NAME}_invoice-service=1 ${STACK_NAME}_site-service=1 --detach
                    echo "Services scaling up..."
                    sleep 60
                '''
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                    echo "=========================================="
                    echo "  Health Check"
                    echo "=========================================="

                    for i in $(seq 1 20); do
                        BOOKING=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001/api/booking 2>/dev/null || echo "000")
                        INVOICE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5002/api/invoice 2>/dev/null || echo "000")
                        SITE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5003/api/site 2>/dev/null || echo "000")

                        echo "Booking: $BOOKING | Invoice: $INVOICE | Site: $SITE"

                        if [ "$BOOKING" = "200" ] && [ "$INVOICE" = "200" ] && [ "$SITE" = "200" ]; then
                            echo "All services healthy!"
                            break
                        fi
                        echo "Waiting for services... ($i/20)"
                        sleep 10
                    done

                    echo ""
                    echo "=== Final Service Status ==="
                    docker stack services ${STACK_NAME}
                '''
            }
        }

        // ==========================================
        // TRIGGER TESTING PIPELINE
        // ==========================================

        stage('Trigger Testing Pipeline') {
            when {
                expression { params.RUN_TESTS == true }
            }
            steps {
                script {
                    echo "=========================================="
                    echo "  Triggering PMS Testing Pipeline"
                    echo "=========================================="

                    // Trigger the pms-testing job (uses its own Jenkinsfile)
                    def testJob = build job: 'pms-testing',
                        parameters: [
                            booleanParam(name: 'HEADLESS', value: true),
                            booleanParam(name: 'PARALLEL_EXECUTION', value: true),
                            string(name: 'MAVEN_GOALS', value: 'clean test')
                        ],
                        wait: params.WAIT_FOR_TESTS,
                        propagate: false  // Don't fail deploy if tests fail

                    if (params.WAIT_FOR_TESTS) {
                        echo "Testing Pipeline Result: ${testJob.result}"

                        if (testJob.result == 'SUCCESS') {
                            echo "All tests passed!"
                        } else if (testJob.result == 'UNSTABLE') {
                            echo "Some tests failed - check Allure report"
                            currentBuild.result = 'UNSTABLE'
                        } else {
                            echo "Testing pipeline failed"
                            // Don't fail the deployment, just warn
                        }

                        echo "View test results: ${testJob.absoluteUrl}allure/"
                    } else {
                        echo "Testing pipeline triggered (not waiting for results)"
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                def testMsg = params.RUN_TESTS ? "\n\nTest Pipeline: Check 'pms-testing' job for results" : ""
                echo """
=========================================
  DEPLOYMENT SUCCESSFUL!
=========================================

Frontend:
  - Admin:  http://localhost:4200
  - Parker: http://localhost:4201

APIs:
  - Booking: http://localhost:5001/api/booking
  - Invoice: http://localhost:5002/api/invoice
  - Site:    http://localhost:5003/api/site

Monitoring:
  - Kibana:     http://localhost:5601
  - Kafka UI:   http://localhost:8085
  - Visualizer: http://localhost:9080
${testMsg}
                """
            }
        }
        failure {
            sh '''
                echo "=== Stack Services Status ==="
                docker stack services ${STACK_NAME} || true
                echo ""
                echo "=== Failed Tasks ==="
                docker stack ps ${STACK_NAME} --no-trunc | grep -E "Failed|Rejected|Shutdown" || true
            '''
        }
    }
}
